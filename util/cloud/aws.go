package cloud

import (
	"bytes"
	"context"
	"net/http"

	"github.com/donkeywon/golib/errs"
	"github.com/donkeywon/golib/util/httpc"
)

var (
	awsInstanceTypeNetworkSpeedMap = map[string]int{
		"a1.2xlarge":          2560,
		"a1.4xlarge":          5120,
		"a1.large":            768,
		"a1.medium":           512,
		"a1.metal":            5120,
		"a1.xlarge":           1280,
		"c1.medium":           307,
		"c1.xlarge":           1024,
		"c3.2xlarge":          1024,
		"c3.4xlarge":          2048,
		"c3.8xlarge":          5120,
		"c3.large":            512,
		"c3.xlarge":           716,
		"c4.2xlarge":          2560,
		"c4.4xlarge":          5120,
		"c4.8xlarge":          10240,
		"c4.large":            640,
		"c4.xlarge":           1280,
		"c5.12xlarge":         12288,
		"c5.18xlarge":         25600,
		"c5.24xlarge":         25600,
		"c5.2xlarge":          2560,
		"c5.4xlarge":          5120,
		"c5.9xlarge":          12288,
		"c5.large":            768,
		"c5.metal":            25600,
		"c5.xlarge":           1280,
		"c5a.12xlarge":        12288,
		"c5a.16xlarge":        20480,
		"c5a.24xlarge":        20480,
		"c5a.2xlarge":         2560,
		"c5a.4xlarge":         5120,
		"c5a.8xlarge":         10240,
		"c5a.large":           768,
		"c5a.xlarge":          1280,
		"c5ad.12xlarge":       12288,
		"c5ad.16xlarge":       20480,
		"c5ad.24xlarge":       20480,
		"c5ad.2xlarge":        2560,
		"c5ad.4xlarge":        5120,
		"c5ad.8xlarge":        10240,
		"c5ad.large":          768,
		"c5ad.xlarge":         1280,
		"c5d.12xlarge":        12288,
		"c5d.18xlarge":        25600,
		"c5d.24xlarge":        25600,
		"c5d.2xlarge":         2560,
		"c5d.4xlarge":         5120,
		"c5d.9xlarge":         12288,
		"c5d.large":           768,
		"c5d.metal":           25600,
		"c5d.xlarge":          1280,
		"c5n.18xlarge":        102400,
		"c5n.2xlarge":         10240,
		"c5n.4xlarge":         15360,
		"c5n.9xlarge":         51200,
		"c5n.large":           3072,
		"c5n.metal":           102400,
		"c5n.xlarge":          5120,
		"c6a.12xlarge":        19200,
		"c6a.16xlarge":        25600,
		"c6a.24xlarge":        38400,
		"c6a.2xlarge":         3200,
		"c6a.32xlarge":        51200,
		"c6a.48xlarge":        51200,
		"c6a.4xlarge":         6400,
		"c6a.8xlarge":         12800,
		"c6a.large":           799,
		"c6a.metal":           51200,
		"c6a.xlarge":          1599,
		"c6g.12xlarge":        20480,
		"c6g.16xlarge":        25600,
		"c6g.2xlarge":         2560,
		"c6g.4xlarge":         5120,
		"c6g.8xlarge":         12288,
		"c6g.large":           768,
		"c6g.medium":          512,
		"c6g.metal":           25600,
		"c6g.xlarge":          1280,
		"c6gd.12xlarge":       20480,
		"c6gd.16xlarge":       25600,
		"c6gd.2xlarge":        2560,
		"c6gd.4xlarge":        5120,
		"c6gd.8xlarge":        12288,
		"c6gd.large":          768,
		"c6gd.medium":         512,
		"c6gd.metal":          25600,
		"c6gd.xlarge":         1280,
		"c6gn.12xlarge":       76800,
		"c6gn.16xlarge":       102400,
		"c6gn.2xlarge":        12800,
		"c6gn.4xlarge":        25600,
		"c6gn.8xlarge":        51200,
		"c6gn.large":          3072,
		"c6gn.medium":         1638,
		"c6gn.xlarge":         6451,
		"c6i.12xlarge":        19200,
		"c6i.16xlarge":        25600,
		"c6i.24xlarge":        38400,
		"c6i.2xlarge":         3200,
		"c6i.32xlarge":        51200,
		"c6i.4xlarge":         6400,
		"c6i.8xlarge":         12800,
		"c6i.large":           799,
		"c6i.metal":           51200,
		"c6i.xlarge":          1599,
		"c6id.12xlarge":       19200,
		"c6id.16xlarge":       25600,
		"c6id.24xlarge":       38400,
		"c6id.2xlarge":        3200,
		"c6id.32xlarge":       51200,
		"c6id.4xlarge":        6400,
		"c6id.8xlarge":        12800,
		"c6id.large":          799,
		"c6id.metal":          51200,
		"c6id.xlarge":         1599,
		"c6in.12xlarge":       76800,
		"c6in.16xlarge":       102400,
		"c6in.24xlarge":       153600,
		"c6in.2xlarge":        12800,
		"c6in.32xlarge":       204800,
		"c6in.4xlarge":        25600,
		"c6in.8xlarge":        51200,
		"c6in.large":          3200,
		"c6in.metal":          204800,
		"c6in.xlarge":         6400,
		"c7a.12xlarge":        19200,
		"c7a.16xlarge":        25600,
		"c7a.24xlarge":        38400,
		"c7a.2xlarge":         3200,
		"c7a.32xlarge":        51200,
		"c7a.48xlarge":        51200,
		"c7a.4xlarge":         6400,
		"c7a.8xlarge":         12800,
		"c7a.large":           799,
		"c7a.medium":          399,
		"c7a.metal-48xl":      51200,
		"c7a.xlarge":          1599,
		"c7g.12xlarge":        23040,
		"c7g.16xlarge":        30720,
		"c7g.2xlarge":         3840,
		"c7g.4xlarge":         7680,
		"c7g.8xlarge":         15360,
		"c7g.large":           959,
		"c7g.medium":          532,
		"c7g.metal":           30720,
		"c7g.xlarge":          1921,
		"c7gd.12xlarge":       23040,
		"c7gd.16xlarge":       30720,
		"c7gd.2xlarge":        3840,
		"c7gd.4xlarge":        7680,
		"c7gd.8xlarge":        15360,
		"c7gd.large":          959,
		"c7gd.medium":         532,
		"c7gd.metal":          30720,
		"c7gd.xlarge":         1921,
		"c7gn.12xlarge":       153600,
		"c7gn.16xlarge":       204800,
		"c7gn.2xlarge":        25600,
		"c7gn.4xlarge":        51200,
		"c7gn.8xlarge":        102400,
		"c7gn.large":          6400,
		"c7gn.medium":         3200,
		"c7gn.metal":          204800,
		"c7gn.xlarge":         12800,
		"c7i-flex.12xlarge":   9600,
		"c7i-flex.16xlarge":   12800,
		"c7i-flex.2xlarge":    1599,
		"c7i-flex.4xlarge":    3200,
		"c7i-flex.8xlarge":    6400,
		"c7i-flex.large":      399,
		"c7i-flex.xlarge":     799,
		"c7i.12xlarge":        19200,
		"c7i.16xlarge":        25600,
		"c7i.24xlarge":        38400,
		"c7i.2xlarge":         3200,
		"c7i.48xlarge":        51200,
		"c7i.4xlarge":         6400,
		"c7i.8xlarge":         12800,
		"c7i.large":           799,
		"c7i.metal-24xl":      38400,
		"c7i.metal-48xl":      51200,
		"c7i.xlarge":          1599,
		"c8g.12xlarge":        23040,
		"c8g.16xlarge":        30720,
		"c8g.24xlarge":        40960,
		"c8g.2xlarge":         3840,
		"c8g.48xlarge":        51200,
		"c8g.4xlarge":         7680,
		"c8g.8xlarge":         15360,
		"c8g.large":           959,
		"c8g.medium":          532,
		"c8g.metal-24xl":      40960,
		"c8g.metal-48xl":      51200,
		"c8g.xlarge":          1920,
		"c8gd.12xlarge":       23040,
		"c8gd.16xlarge":       30720,
		"c8gd.24xlarge":       40960,
		"c8gd.2xlarge":        3840,
		"c8gd.48xlarge":       51200,
		"c8gd.4xlarge":        7680,
		"c8gd.8xlarge":        15360,
		"c8gd.large":          959,
		"c8gd.medium":         532,
		"c8gd.metal-24xl":     40960,
		"c8gd.metal-48xl":     51200,
		"c8gd.xlarge":         1920,
		"c8gn.12xlarge":       153600,
		"c8gn.16xlarge":       204800,
		"c8gn.24xlarge":       307200,
		"c8gn.2xlarge":        25600,
		"c8gn.48xlarge":       307200,
		"c8gn.4xlarge":        51200,
		"c8gn.8xlarge":        102400,
		"c8gn.large":          6400,
		"c8gn.medium":         3200,
		"c8gn.xlarge":         12800,
		"c8i-flex.12xlarge":   11520,
		"c8i-flex.16xlarge":   15360,
		"c8i-flex.2xlarge":    1920,
		"c8i-flex.4xlarge":    3840,
		"c8i-flex.8xlarge":    7680,
		"c8i-flex.large":      479,
		"c8i-flex.xlarge":     959,
		"c8i.12xlarge":        23040,
		"c8i.16xlarge":        30720,
		"c8i.24xlarge":        40960,
		"c8i.2xlarge":         3840,
		"c8i.32xlarge":        51200,
		"c8i.48xlarge":        76800,
		"c8i.4xlarge":         7680,
		"c8i.8xlarge":         15360,
		"c8i.96xlarge":        102400,
		"c8i.large":           959,
		"c8i.metal-48xl":      76800,
		"c8i.metal-96xl":      102400,
		"c8i.xlarge":          1920,
		"d2.2xlarge":          2560,
		"d2.4xlarge":          5120,
		"d2.8xlarge":          10240,
		"d2.xlarge":           1280,
		"d3.2xlarge":          6144,
		"d3.4xlarge":          12800,
		"d3.8xlarge":          25600,
		"d3.xlarge":           3072,
		"d3en.12xlarge":       76800,
		"d3en.2xlarge":        12800,
		"d3en.4xlarge":        25600,
		"d3en.6xlarge":        40960,
		"d3en.8xlarge":        51200,
		"d3en.xlarge":         6144,
		"dl1.24xlarge":        102400,
		"dl2q.24xlarge":       102400,
		"f1.16xlarge":         5120,
		"f1.2xlarge":          2560,
		"f1.4xlarge":          5120,
		"f2.12xlarge":         25600,
		"f2.48xlarge":         102400,
		"f2.6xlarge":          12800,
		"g4ad.16xlarge":       25600,
		"g4ad.2xlarge":        4267,
		"g4ad.4xlarge":        8532,
		"g4ad.8xlarge":        15360,
		"g4ad.xlarge":         2048,
		"g4dn.12xlarge":       51200,
		"g4dn.16xlarge":       51200,
		"g4dn.2xlarge":        10240,
		"g4dn.4xlarge":        20480,
		"g4dn.8xlarge":        51200,
		"g4dn.metal":          102400,
		"g4dn.xlarge":         5120,
		"g5.12xlarge":         40960,
		"g5.16xlarge":         25600,
		"g5.24xlarge":         51200,
		"g5.2xlarge":          5120,
		"g5.48xlarge":         102400,
		"g5.4xlarge":          10240,
		"g5.8xlarge":          25600,
		"g5.xlarge":           2560,
		"g5g.16xlarge":        25600,
		"g5g.2xlarge":         2560,
		"g5g.4xlarge":         5120,
		"g5g.8xlarge":         12288,
		"g5g.metal":           25600,
		"g5g.xlarge":          1280,
		"g6.12xlarge":         40960,
		"g6.16xlarge":         25600,
		"g6.24xlarge":         51200,
		"g6.2xlarge":          5120,
		"g6.48xlarge":         102400,
		"g6.4xlarge":          10240,
		"g6.8xlarge":          25600,
		"g6.xlarge":           2560,
		"g6e.12xlarge":        102400,
		"g6e.16xlarge":        35840,
		"g6e.24xlarge":        204800,
		"g6e.2xlarge":         5120,
		"g6e.48xlarge":        409600,
		"g6e.4xlarge":         20480,
		"g6e.8xlarge":         25600,
		"g6e.xlarge":          2560,
		"g6f.2xlarge":         5120,
		"g6f.4xlarge":         10240,
		"g6f.large":           1536,
		"g6f.xlarge":          2560,
		"gr6.4xlarge":         10240,
		"gr6.8xlarge":         25600,
		"gr6f.4xlarge":        10240,
		"h1.16xlarge":         25600,
		"h1.2xlarge":          2560,
		"h1.4xlarge":          5120,
		"h1.8xlarge":          12288,
		"i2.2xlarge":          1024,
		"i2.4xlarge":          2048,
		"i2.8xlarge":          10240,
		"i2.xlarge":           716,
		"i3.16xlarge":         25600,
		"i3.2xlarge":          2560,
		"i3.4xlarge":          5120,
		"i3.8xlarge":          12288,
		"i3.large":            768,
		"i3.xlarge":           1280,
		"i3en.12xlarge":       51200,
		"i3en.24xlarge":       102400,
		"i3en.2xlarge":        8601,
		"i3en.3xlarge":        12800,
		"i3en.6xlarge":        25600,
		"i3en.large":          2150,
		"i3en.metal":          102400,
		"i3en.xlarge":         4300,
		"i4g.16xlarge":        38400,
		"i4g.2xlarge":         4799,
		"i4g.4xlarge":         9600,
		"i4g.8xlarge":         19200,
		"i4g.large":           799,
		"i4g.xlarge":          1920,
		"i4i.12xlarge":        28800,
		"i4i.16xlarge":        38400,
		"i4i.24xlarge":        57600,
		"i4i.2xlarge":         4799,
		"i4i.32xlarge":        76800,
		"i4i.4xlarge":         9600,
		"i4i.8xlarge":         19200,
		"i4i.large":           799,
		"i4i.metal":           76800,
		"i4i.xlarge":          1920,
		"i7i.12xlarge":        23040,
		"i7i.16xlarge":        30720,
		"i7i.24xlarge":        46080,
		"i7i.2xlarge":         4799,
		"i7i.48xlarge":        92160,
		"i7i.4xlarge":         9600,
		"i7i.8xlarge":         15360,
		"i7i.large":           1199,
		"i7i.metal-24xl":      46080,
		"i7i.metal-48xl":      92160,
		"i7i.xlarge":          2399,
		"i7ie.12xlarge":       25600,
		"i7ie.18xlarge":       38400,
		"i7ie.24xlarge":       51200,
		"i7ie.2xlarge":        8532,
		"i7ie.3xlarge":        12800,
		"i7ie.48xlarge":       102400,
		"i7ie.6xlarge":        12800,
		"i7ie.large":          2132,
		"i7ie.metal-24xl":     51200,
		"i7ie.metal-48xl":     102400,
		"i7ie.xlarge":         4265,
		"i8g.12xlarge":        23040,
		"i8g.16xlarge":        30720,
		"i8g.24xlarge":        46080,
		"i8g.2xlarge":         4800,
		"i8g.48xlarge":        92160,
		"i8g.4xlarge":         9600,
		"i8g.8xlarge":         15360,
		"i8g.large":           1200,
		"i8g.metal-24xl":      46080,
		"i8g.xlarge":          2400,
		"i8ge.12xlarge":       46080,
		"i8ge.18xlarge":       69120,
		"i8ge.24xlarge":       92160,
		"i8ge.2xlarge":        8601,
		"i8ge.3xlarge":        12800,
		"i8ge.48xlarge":       184320,
		"i8ge.6xlarge":        23040,
		"i8ge.large":          2150,
		"i8ge.metal-24xl":     92160,
		"i8ge.metal-48xl":     184320,
		"i8ge.xlarge":         4300,
		"im4gn.16xlarge":      102400,
		"im4gn.2xlarge":       12800,
		"im4gn.4xlarge":       25600,
		"im4gn.8xlarge":       51200,
		"im4gn.large":         3200,
		"im4gn.xlarge":        6400,
		"inf1.24xlarge":       102400,
		"inf1.2xlarge":        5120,
		"inf1.6xlarge":        25600,
		"inf1.xlarge":         5120,
		"inf2.24xlarge":       51200,
		"inf2.48xlarge":       102400,
		"inf2.8xlarge":        17067,
		"inf2.xlarge":         2132,
		"is4gen.2xlarge":      12800,
		"is4gen.4xlarge":      25600,
		"is4gen.8xlarge":      51200,
		"is4gen.large":        3200,
		"is4gen.medium":       1599,
		"is4gen.xlarge":       6400,
		"m1.large":            716,
		"m1.medium":           307,
		"m1.small":            307,
		"m1.xlarge":           1024,
		"m2.2xlarge":          716,
		"m2.4xlarge":          1024,
		"m2.xlarge":           307,
		"m3.2xlarge":          1024,
		"m3.large":            716,
		"m3.medium":           307,
		"m3.xlarge":           1024,
		"m4.10xlarge":         10240,
		"m4.16xlarge":         25600,
		"m4.2xlarge":          1024,
		"m4.4xlarge":          2048,
		"m4.large":            460,
		"m4.xlarge":           768,
		"m5.12xlarge":         12288,
		"m5.16xlarge":         20480,
		"m5.24xlarge":         25600,
		"m5.2xlarge":          2560,
		"m5.4xlarge":          5120,
		"m5.8xlarge":          10240,
		"m5.large":            768,
		"m5.metal":            25600,
		"m5.xlarge":           1280,
		"m5a.12xlarge":        10240,
		"m5a.16xlarge":        12288,
		"m5a.24xlarge":        20480,
		"m5a.2xlarge":         2560,
		"m5a.4xlarge":         5120,
		"m5a.8xlarge":         7680,
		"m5a.large":           768,
		"m5a.xlarge":          1280,
		"m5ad.12xlarge":       10240,
		"m5ad.16xlarge":       12288,
		"m5ad.24xlarge":       20480,
		"m5ad.2xlarge":        2560,
		"m5ad.4xlarge":        5120,
		"m5ad.8xlarge":        7680,
		"m5ad.large":          768,
		"m5ad.xlarge":         1280,
		"m5d.12xlarge":        12288,
		"m5d.16xlarge":        20480,
		"m5d.24xlarge":        25600,
		"m5d.2xlarge":         2560,
		"m5d.4xlarge":         5120,
		"m5d.8xlarge":         10240,
		"m5d.large":           768,
		"m5d.metal":           25600,
		"m5d.xlarge":          1280,
		"m5dn.12xlarge":       51200,
		"m5dn.16xlarge":       76800,
		"m5dn.24xlarge":       102400,
		"m5dn.2xlarge":        8320,
		"m5dn.4xlarge":        16640,
		"m5dn.8xlarge":        25600,
		"m5dn.large":          2150,
		"m5dn.metal":          102400,
		"m5dn.xlarge":         4198,
		"m5n.12xlarge":        51200,
		"m5n.16xlarge":        76800,
		"m5n.24xlarge":        102400,
		"m5n.2xlarge":         8320,
		"m5n.4xlarge":         16640,
		"m5n.8xlarge":         25600,
		"m5n.large":           2150,
		"m5n.metal":           102400,
		"m5n.xlarge":          4198,
		"m5zn.12xlarge":       102400,
		"m5zn.2xlarge":        10240,
		"m5zn.3xlarge":        15360,
		"m5zn.6xlarge":        51200,
		"m5zn.large":          3072,
		"m5zn.metal":          102400,
		"m5zn.xlarge":         5120,
		"m6a.12xlarge":        19200,
		"m6a.16xlarge":        25600,
		"m6a.24xlarge":        38400,
		"m6a.2xlarge":         3200,
		"m6a.32xlarge":        51200,
		"m6a.48xlarge":        51200,
		"m6a.4xlarge":         6400,
		"m6a.8xlarge":         12800,
		"m6a.large":           799,
		"m6a.metal":           51200,
		"m6a.xlarge":          1599,
		"m6g.12xlarge":        20480,
		"m6g.16xlarge":        25600,
		"m6g.2xlarge":         2560,
		"m6g.4xlarge":         5120,
		"m6g.8xlarge":         12288,
		"m6g.large":           768,
		"m6g.medium":          512,
		"m6g.metal":           25600,
		"m6g.xlarge":          1280,
		"m6gd.12xlarge":       20480,
		"m6gd.16xlarge":       25600,
		"m6gd.2xlarge":        2560,
		"m6gd.4xlarge":        5120,
		"m6gd.8xlarge":        12288,
		"m6gd.large":          768,
		"m6gd.medium":         512,
		"m6gd.metal":          25600,
		"m6gd.xlarge":         1280,
		"m6i.12xlarge":        19200,
		"m6i.16xlarge":        25600,
		"m6i.24xlarge":        38400,
		"m6i.2xlarge":         3200,
		"m6i.32xlarge":        51200,
		"m6i.4xlarge":         6400,
		"m6i.8xlarge":         12800,
		"m6i.large":           799,
		"m6i.metal":           51200,
		"m6i.xlarge":          1599,
		"m6id.12xlarge":       19200,
		"m6id.16xlarge":       25600,
		"m6id.24xlarge":       38400,
		"m6id.2xlarge":        3200,
		"m6id.32xlarge":       51200,
		"m6id.4xlarge":        6400,
		"m6id.8xlarge":        12800,
		"m6id.large":          799,
		"m6id.metal":          51200,
		"m6id.xlarge":         1599,
		"m6idn.12xlarge":      76800,
		"m6idn.16xlarge":      102400,
		"m6idn.24xlarge":      153600,
		"m6idn.2xlarge":       12800,
		"m6idn.32xlarge":      204800,
		"m6idn.4xlarge":       25600,
		"m6idn.8xlarge":       51200,
		"m6idn.large":         3200,
		"m6idn.metal":         204800,
		"m6idn.xlarge":        6400,
		"m6in.12xlarge":       76800,
		"m6in.16xlarge":       102400,
		"m6in.24xlarge":       153600,
		"m6in.2xlarge":        12800,
		"m6in.32xlarge":       204800,
		"m6in.4xlarge":        25600,
		"m6in.8xlarge":        51200,
		"m6in.large":          3200,
		"m6in.metal":          204800,
		"m6in.xlarge":         6400,
		"m7a.12xlarge":        19200,
		"m7a.16xlarge":        25600,
		"m7a.24xlarge":        38400,
		"m7a.2xlarge":         3200,
		"m7a.32xlarge":        51200,
		"m7a.48xlarge":        51200,
		"m7a.4xlarge":         6400,
		"m7a.8xlarge":         12800,
		"m7a.large":           799,
		"m7a.medium":          399,
		"m7a.metal-48xl":      51200,
		"m7a.xlarge":          1599,
		"m7g.12xlarge":        23040,
		"m7g.16xlarge":        30720,
		"m7g.2xlarge":         3840,
		"m7g.4xlarge":         7680,
		"m7g.8xlarge":         15360,
		"m7g.large":           959,
		"m7g.medium":          532,
		"m7g.metal":           30720,
		"m7g.xlarge":          1921,
		"m7gd.12xlarge":       23040,
		"m7gd.16xlarge":       30720,
		"m7gd.2xlarge":        3840,
		"m7gd.4xlarge":        7680,
		"m7gd.8xlarge":        15360,
		"m7gd.large":          959,
		"m7gd.medium":         532,
		"m7gd.metal":          30720,
		"m7gd.xlarge":         1921,
		"m7i-flex.12xlarge":   9600,
		"m7i-flex.16xlarge":   12800,
		"m7i-flex.2xlarge":    1599,
		"m7i-flex.4xlarge":    3200,
		"m7i-flex.8xlarge":    6400,
		"m7i-flex.large":      399,
		"m7i-flex.xlarge":     799,
		"m7i.12xlarge":        19200,
		"m7i.16xlarge":        25600,
		"m7i.24xlarge":        38400,
		"m7i.2xlarge":         3200,
		"m7i.48xlarge":        51200,
		"m7i.4xlarge":         6400,
		"m7i.8xlarge":         12800,
		"m7i.large":           799,
		"m7i.metal-24xl":      38400,
		"m7i.metal-48xl":      51200,
		"m7i.xlarge":          1599,
		"m8a.12xlarge":        23040,
		"m8a.16xlarge":        30720,
		"m8a.24xlarge":        40960,
		"m8a.2xlarge":         3840,
		"m8a.48xlarge":        76800,
		"m8a.4xlarge":         7680,
		"m8a.8xlarge":         15360,
		"m8a.large":           959,
		"m8a.medium":          532,
		"m8a.metal-24xl":      40960,
		"m8a.metal-48xl":      76800,
		"m8a.xlarge":          1920,
		"m8g.12xlarge":        23040,
		"m8g.16xlarge":        30720,
		"m8g.24xlarge":        40960,
		"m8g.2xlarge":         3840,
		"m8g.48xlarge":        51200,
		"m8g.4xlarge":         7680,
		"m8g.8xlarge":         15360,
		"m8g.large":           959,
		"m8g.medium":          532,
		"m8g.metal-24xl":      40960,
		"m8g.metal-48xl":      51200,
		"m8g.xlarge":          1920,
		"m8gd.12xlarge":       23040,
		"m8gd.16xlarge":       30720,
		"m8gd.24xlarge":       40960,
		"m8gd.2xlarge":        3840,
		"m8gd.48xlarge":       51200,
		"m8gd.4xlarge":        7680,
		"m8gd.8xlarge":        15360,
		"m8gd.large":          959,
		"m8gd.medium":         532,
		"m8gd.metal-24xl":     40960,
		"m8gd.metal-48xl":     51200,
		"m8gd.xlarge":         1920,
		"m8i-flex.12xlarge":   11520,
		"m8i-flex.16xlarge":   15360,
		"m8i-flex.2xlarge":    1920,
		"m8i-flex.4xlarge":    3840,
		"m8i-flex.8xlarge":    7680,
		"m8i-flex.large":      479,
		"m8i-flex.xlarge":     959,
		"m8i.12xlarge":        23040,
		"m8i.16xlarge":        30720,
		"m8i.24xlarge":        40960,
		"m8i.2xlarge":         3840,
		"m8i.32xlarge":        51200,
		"m8i.48xlarge":        76800,
		"m8i.4xlarge":         7680,
		"m8i.8xlarge":         15360,
		"m8i.96xlarge":        102400,
		"m8i.large":           959,
		"m8i.metal-48xl":      76800,
		"m8i.metal-96xl":      102400,
		"m8i.xlarge":          1920,
		"mac-m4.metal":        10240,
		"mac-m4pro.metal":     10240,
		"mac1.metal":          25600,
		"mac2-m1ultra.metal":  10240,
		"mac2-m2.metal":       10240,
		"mac2-m2pro.metal":    10240,
		"mac2.metal":          10240,
		"p3.16xlarge":         5120,
		"p3.2xlarge":          2560,
		"p3.8xlarge":          5120,
		"p3dn.24xlarge":       102400,
		"p4d.24xlarge":        102400,
		"p4de.24xlarge":       102400,
		"p5.48xlarge":         102400,
		"p5.4xlarge":          102400,
		"p5e.48xlarge":        102400,
		"p5en.48xlarge":       204800,
		"p6-b200.48xlarge":    204800,
		"r3.2xlarge":          1024,
		"r3.4xlarge":          2048,
		"r3.8xlarge":          5120,
		"r3.large":            512,
		"r3.xlarge":           716,
		"r4.16xlarge":         25600,
		"r4.2xlarge":          2560,
		"r4.4xlarge":          5120,
		"r4.8xlarge":          12288,
		"r4.large":            768,
		"r4.xlarge":           1280,
		"r5.12xlarge":         12288,
		"r5.16xlarge":         20480,
		"r5.24xlarge":         25600,
		"r5.2xlarge":          2560,
		"r5.4xlarge":          5120,
		"r5.8xlarge":          10240,
		"r5.large":            768,
		"r5.metal":            25600,
		"r5.xlarge":           1280,
		"r5a.12xlarge":        10240,
		"r5a.16xlarge":        12288,
		"r5a.24xlarge":        20480,
		"r5a.2xlarge":         2560,
		"r5a.4xlarge":         5120,
		"r5a.8xlarge":         7680,
		"r5a.large":           768,
		"r5a.xlarge":          1280,
		"r5ad.12xlarge":       10240,
		"r5ad.16xlarge":       12288,
		"r5ad.24xlarge":       20480,
		"r5ad.2xlarge":        2560,
		"r5ad.4xlarge":        5120,
		"r5ad.8xlarge":        7680,
		"r5ad.large":          768,
		"r5ad.xlarge":         1280,
		"r5b.12xlarge":        12288,
		"r5b.16xlarge":        20480,
		"r5b.24xlarge":        25600,
		"r5b.2xlarge":         2560,
		"r5b.4xlarge":         5120,
		"r5b.8xlarge":         10240,
		"r5b.large":           768,
		"r5b.metal":           25600,
		"r5b.xlarge":          1280,
		"r5d.12xlarge":        12288,
		"r5d.16xlarge":        20480,
		"r5d.24xlarge":        25600,
		"r5d.2xlarge":         2560,
		"r5d.4xlarge":         5120,
		"r5d.8xlarge":         10240,
		"r5d.large":           768,
		"r5d.metal":           25600,
		"r5d.xlarge":          1280,
		"r5dn.12xlarge":       51200,
		"r5dn.16xlarge":       76800,
		"r5dn.24xlarge":       102400,
		"r5dn.2xlarge":        8320,
		"r5dn.4xlarge":        16640,
		"r5dn.8xlarge":        25600,
		"r5dn.large":          2150,
		"r5dn.metal":          102400,
		"r5dn.xlarge":         4198,
		"r5n.12xlarge":        51200,
		"r5n.16xlarge":        76800,
		"r5n.24xlarge":        102400,
		"r5n.2xlarge":         8320,
		"r5n.4xlarge":         16640,
		"r5n.8xlarge":         25600,
		"r5n.large":           2150,
		"r5n.metal":           102400,
		"r5n.xlarge":          4198,
		"r6a.12xlarge":        19200,
		"r6a.16xlarge":        25600,
		"r6a.24xlarge":        38400,
		"r6a.2xlarge":         3200,
		"r6a.32xlarge":        51200,
		"r6a.48xlarge":        51200,
		"r6a.4xlarge":         6400,
		"r6a.8xlarge":         12800,
		"r6a.large":           799,
		"r6a.metal":           51200,
		"r6a.xlarge":          1599,
		"r6g.12xlarge":        20480,
		"r6g.16xlarge":        25600,
		"r6g.2xlarge":         2560,
		"r6g.4xlarge":         5120,
		"r6g.8xlarge":         12288,
		"r6g.large":           768,
		"r6g.medium":          512,
		"r6g.metal":           25600,
		"r6g.xlarge":          1280,
		"r6gd.12xlarge":       20480,
		"r6gd.16xlarge":       25600,
		"r6gd.2xlarge":        2560,
		"r6gd.4xlarge":        5120,
		"r6gd.8xlarge":        12288,
		"r6gd.large":          768,
		"r6gd.medium":         512,
		"r6gd.metal":          25600,
		"r6gd.xlarge":         1280,
		"r6i.12xlarge":        19200,
		"r6i.16xlarge":        25600,
		"r6i.24xlarge":        38400,
		"r6i.2xlarge":         3200,
		"r6i.32xlarge":        51200,
		"r6i.4xlarge":         6400,
		"r6i.8xlarge":         12800,
		"r6i.large":           799,
		"r6i.metal":           51200,
		"r6i.xlarge":          1599,
		"r6id.12xlarge":       19200,
		"r6id.16xlarge":       25600,
		"r6id.24xlarge":       38400,
		"r6id.2xlarge":        3200,
		"r6id.32xlarge":       51200,
		"r6id.4xlarge":        6400,
		"r6id.8xlarge":        12800,
		"r6id.large":          799,
		"r6id.metal":          51200,
		"r6id.xlarge":         1599,
		"r6idn.12xlarge":      76800,
		"r6idn.16xlarge":      102400,
		"r6idn.24xlarge":      153600,
		"r6idn.2xlarge":       12800,
		"r6idn.32xlarge":      204800,
		"r6idn.4xlarge":       25600,
		"r6idn.8xlarge":       51200,
		"r6idn.large":         3200,
		"r6idn.metal":         204800,
		"r6idn.xlarge":        6400,
		"r6in.12xlarge":       76800,
		"r6in.16xlarge":       102400,
		"r6in.24xlarge":       153600,
		"r6in.2xlarge":        12800,
		"r6in.32xlarge":       204800,
		"r6in.4xlarge":        25600,
		"r6in.8xlarge":        51200,
		"r6in.large":          3200,
		"r6in.metal":          204800,
		"r6in.xlarge":         6400,
		"r7a.12xlarge":        19200,
		"r7a.16xlarge":        25600,
		"r7a.24xlarge":        38400,
		"r7a.2xlarge":         3200,
		"r7a.32xlarge":        51200,
		"r7a.48xlarge":        51200,
		"r7a.4xlarge":         6400,
		"r7a.8xlarge":         12800,
		"r7a.large":           799,
		"r7a.medium":          399,
		"r7a.metal-48xl":      51200,
		"r7a.xlarge":          1599,
		"r7g.12xlarge":        23040,
		"r7g.16xlarge":        30720,
		"r7g.2xlarge":         3840,
		"r7g.4xlarge":         7680,
		"r7g.8xlarge":         15360,
		"r7g.large":           959,
		"r7g.medium":          532,
		"r7g.metal":           30720,
		"r7g.xlarge":          1921,
		"r7gd.12xlarge":       23040,
		"r7gd.16xlarge":       30720,
		"r7gd.2xlarge":        3840,
		"r7gd.4xlarge":        7680,
		"r7gd.8xlarge":        15360,
		"r7gd.large":          959,
		"r7gd.medium":         532,
		"r7gd.metal":          30720,
		"r7gd.xlarge":         1921,
		"r7i.12xlarge":        19200,
		"r7i.16xlarge":        25600,
		"r7i.24xlarge":        38400,
		"r7i.2xlarge":         3200,
		"r7i.48xlarge":        51200,
		"r7i.4xlarge":         6400,
		"r7i.8xlarge":         12800,
		"r7i.large":           799,
		"r7i.metal-24xl":      38400,
		"r7i.metal-48xl":      51200,
		"r7i.xlarge":          1599,
		"r7iz.12xlarge":       25600,
		"r7iz.16xlarge":       25600,
		"r7iz.2xlarge":        3200,
		"r7iz.32xlarge":       51200,
		"r7iz.4xlarge":        6400,
		"r7iz.8xlarge":        12800,
		"r7iz.large":          799,
		"r7iz.metal-16xl":     25600,
		"r7iz.metal-32xl":     51200,
		"r7iz.xlarge":         1599,
		"r8g.12xlarge":        23040,
		"r8g.16xlarge":        30720,
		"r8g.24xlarge":        40960,
		"r8g.2xlarge":         3840,
		"r8g.48xlarge":        51200,
		"r8g.4xlarge":         7680,
		"r8g.8xlarge":         15360,
		"r8g.large":           959,
		"r8g.medium":          532,
		"r8g.metal-24xl":      40960,
		"r8g.metal-48xl":      51200,
		"r8g.xlarge":          1920,
		"r8gb.12xlarge":       102400,
		"r8gb.16xlarge":       136532,
		"r8gb.24xlarge":       204800,
		"r8gb.2xlarge":        17065,
		"r8gb.4xlarge":        34132,
		"r8gb.8xlarge":        68265,
		"r8gb.large":          4265,
		"r8gb.medium":         2132,
		"r8gb.xlarge":         8532,
		"r8gd.12xlarge":       23040,
		"r8gd.16xlarge":       30720,
		"r8gd.24xlarge":       40960,
		"r8gd.2xlarge":        3840,
		"r8gd.48xlarge":       51200,
		"r8gd.4xlarge":        7680,
		"r8gd.8xlarge":        15360,
		"r8gd.large":          959,
		"r8gd.medium":         532,
		"r8gd.metal-24xl":     40960,
		"r8gd.metal-48xl":     51200,
		"r8gd.xlarge":         1920,
		"r8gn.12xlarge":       153600,
		"r8gn.16xlarge":       204800,
		"r8gn.24xlarge":       307200,
		"r8gn.2xlarge":        25600,
		"r8gn.48xlarge":       307200,
		"r8gn.4xlarge":        51200,
		"r8gn.8xlarge":        102400,
		"r8gn.large":          6400,
		"r8gn.medium":         3200,
		"r8gn.xlarge":         12800,
		"r8i-flex.12xlarge":   11520,
		"r8i-flex.16xlarge":   15360,
		"r8i-flex.2xlarge":    1920,
		"r8i-flex.4xlarge":    3840,
		"r8i-flex.8xlarge":    7680,
		"r8i-flex.large":      479,
		"r8i-flex.xlarge":     959,
		"r8i.12xlarge":        23040,
		"r8i.16xlarge":        30720,
		"r8i.24xlarge":        40960,
		"r8i.2xlarge":         3840,
		"r8i.32xlarge":        51200,
		"r8i.48xlarge":        76800,
		"r8i.4xlarge":         7680,
		"r8i.8xlarge":         15360,
		"r8i.96xlarge":        102400,
		"r8i.large":           959,
		"r8i.metal-48xl":      76800,
		"r8i.metal-96xl":      102400,
		"r8i.xlarge":          1920,
		"t1.micro":            71,
		"t2.2xlarge":          1024,
		"t2.large":            524,
		"t2.medium":           262,
		"t2.micro":            65,
		"t2.nano":             32,
		"t2.small":            131,
		"t2.xlarge":           768,
		"t3.2xlarge":          2097,
		"t3.large":            524,
		"t3.medium":           262,
		"t3.micro":            65,
		"t3.nano":             32,
		"t3.small":            131,
		"t3.xlarge":           1048,
		"t3a.2xlarge":         2097,
		"t3a.large":           524,
		"t3a.medium":          262,
		"t3a.micro":           65,
		"t3a.nano":            32,
		"t3a.small":           131,
		"t3a.xlarge":          1048,
		"t4g.2xlarge":         2097,
		"t4g.large":           524,
		"t4g.medium":          262,
		"t4g.micro":           65,
		"t4g.nano":            32,
		"t4g.small":           131,
		"t4g.xlarge":          1048,
		"trn1.2xlarge":        3200,
		"trn1.32xlarge":       102400,
		"trn1n.32xlarge":      102400,
		"u-3tb1.56xlarge":     51200,
		"u-6tb1.112xlarge":    102400,
		"u-6tb1.56xlarge":     102400,
		"u7i-12tb.224xlarge":  102400,
		"u7i-6tb.112xlarge":   102400,
		"u7i-8tb.112xlarge":   102400,
		"u7in-16tb.224xlarge": 102400,
		"u7in-24tb.224xlarge": 102400,
		"u7in-32tb.224xlarge": 102400,
		"vt1.24xlarge":        25600,
		"vt1.3xlarge":         3200,
		"vt1.6xlarge":         6400,
		"x1.16xlarge":         10240,
		"x1.32xlarge":         25600,
		"x1e.16xlarge":        10240,
		"x1e.2xlarge":         1280,
		"x1e.32xlarge":        25600,
		"x1e.4xlarge":         2560,
		"x1e.8xlarge":         5120,
		"x1e.xlarge":          640,
		"x2gd.12xlarge":       20480,
		"x2gd.16xlarge":       25600,
		"x2gd.2xlarge":        2560,
		"x2gd.4xlarge":        5120,
		"x2gd.8xlarge":        12288,
		"x2gd.large":          768,
		"x2gd.medium":         512,
		"x2gd.metal":          25600,
		"x2gd.xlarge":         1280,
		"x2idn.16xlarge":      51200,
		"x2idn.24xlarge":      76800,
		"x2idn.32xlarge":      102400,
		"x2idn.metal":         102400,
		"x2iedn.16xlarge":     51200,
		"x2iedn.24xlarge":     76800,
		"x2iedn.2xlarge":      5120,
		"x2iedn.32xlarge":     102400,
		"x2iedn.4xlarge":      12800,
		"x2iedn.8xlarge":      25600,
		"x2iedn.metal":        102400,
		"x2iedn.xlarge":       1920,
		"x2iezn.12xlarge":     102400,
		"x2iezn.2xlarge":      12800,
		"x2iezn.4xlarge":      15360,
		"x2iezn.6xlarge":      51200,
		"x2iezn.8xlarge":      76800,
		"x2iezn.metal":        102400,
		"x8g.12xlarge":        23040,
		"x8g.16xlarge":        30720,
		"x8g.24xlarge":        40960,
		"x8g.2xlarge":         3840,
		"x8g.48xlarge":        51200,
		"x8g.4xlarge":         7680,
		"x8g.8xlarge":         15360,
		"x8g.large":           959,
		"x8g.medium":          532,
		"x8g.metal-24xl":      40960,
		"x8g.metal-48xl":      51200,
		"x8g.xlarge":          1920,
		"z1d.12xlarge":        25600,
		"z1d.2xlarge":         2560,
		"z1d.3xlarge":         5120,
		"z1d.6xlarge":         12288,
		"z1d.large":           768,
		"z1d.metal":           25600,
		"z1d.xlarge":          1280,
	}
)

func IsAws() bool {
	token, err := GetEC2IMDSv2Token()
	if token.Len() > 0 && err == nil {
		return true
	}
	return false
}

func GetEC2InstanceType() (*bytes.Buffer, error) {
	token, err := GetEC2IMDSv2Token()
	if err != nil {
		return nil, err
	}

	body := bytes.NewBuffer(nil)
	_, err = httpc.Get(context.Background(), cloudMetadataReqTimeout, "http://169.254.169.254/latest/meta-data/instance-type",
		httpc.WithHeaders("X-aws-ec2-metadata-token", token.String()),
		httpc.CheckStatusCode(http.StatusOK),
		httpc.ToBytesBuffer(body),
	)
	return body, err
}

func GetAwsEc2NetSpeed() (int, error) {
	instanceType, err := GetEC2InstanceType()
	if err != nil {
		return 0, err
	}

	instanceTypeStr := instanceType.String()
	speed, exists := awsInstanceTypeNetworkSpeedMap[instanceTypeStr]
	if !exists {
		return 0, errs.Errorf("instance net speed not found, type: %s", instanceTypeStr)
	}

	return speed, nil
}

func GetEC2IMDSv2Token() (*bytes.Buffer, error) {
	body := bytes.NewBuffer(nil)
	_, err := httpc.Put(context.Background(), cloudMetadataReqTimeout, "http://169.254.169.254/latest/api/token",
		httpc.WithHeaders("X-aws-ec2-metadata-token-ttl-seconds", "30"),
		httpc.CheckStatusCode(http.StatusOK),
		httpc.ToBytesBuffer(body),
	)
	return body, err
}
